# 飞书开放平台配置检查清单

**重要**: 代码和WebSocket连接都正常，问题100%在飞书开放平台配置！

---

## 🔍 必须检查的配置

### 1. 登录飞书开放平台
URL: https://open.feishu.cn/app

### 2. 选择你的应用
App ID: `cli_a85b46e11ff6500d`

---

## ✅ 检查清单

### A. 应用基本状态
进入：开发配置 → 应用信息

- [ ] **应用状态**: 必须是「启用中」
- [ ] **应用版本**: 检查是否有版本审核中
- [ ] **可用范围**: 确认包含你发送消息的用户

---

### B. 事件订阅配置 ⭐️ **最关键**
进入：开发配置 → 事件订阅

**检查以下项目**:

#### 1. 订阅方式
- [ ] **必须选择**: 「WebSocket 方式」
- [ ] **不能是**: 「请求网址（HTTP）」

#### 2. 事件列表
- [ ] **必须订阅**: `im.message.receive_v1` (接收消息)
  - 如果没有，点击「添加事件」→ 搜索「消息」→ 勾选「接收消息」

#### 3. 订阅状态
- [ ] **状态**: 必须是「已启用」或「正常」
- [ ] **不能是**: 「已暂停」、「已禁用」

#### 4. 其他可选事件（建议也订阅）
- [ ] `im.message.message_read_v1` (消息已读)
- [ ] `im.message.reaction.created_v1` (表情回复)

---

### C. 权限配置
进入：开发配置 → 权限管理

**必须开通的权限**:
- [ ] `im:message` - 获取与发送单聊、群组消息
- [ ] `im:message:group` - 获取群组中所有消息
- [ ] `im:message.group_msg:readonly` - 接收群聊中@机器人消息
- [ ] `im:message.p2p_msg:readonly` - 接收单聊消息
- [ ] `im:message:send_as_bot` - 以应用的身份发消息

---

### D. 机器人配置
进入：功能配置 → 机器人

- [ ] **机器人状态**: 已启用
- [ ] **消息卡片请求网址**: 可以留空（我们不用）
- [ ] **首页地址**: 可以留空

---

### E. 版本管理与发布
进入：版本管理与发布

- [ ] **当前版本状态**: 「已上线」
- [ ] **检查是否有待审核版本**: 如果有，可能需要等待审核
- [ ] **如果修改了权限**: 需要创建新版本并提交审核

---

## 🔧 常见问题排查

### 问题1: 找不到「事件订阅」菜单
**原因**: 应用类型不支持
**解决**:
1. 确认应用类型是「企业自建应用」或「企业内测应用」
2. 商店应用不支持WebSocket模式

### 问题2: 无法切换到WebSocket方式
**原因**: 之前配置了HTTP回调
**解决**:
1. 删除HTTP回调地址
2. 保存后刷新页面
3. 应该能看到WebSocket选项

### 问题3: 权限列表找不到某些权限
**原因**: 权限范围受应用类型限制
**解决**:
1. 检查应用类型
2. 部分权限需要企业认证

### 问题4: 事件订阅显示「已暂停」
**原因**:
- 应用异常导致自动暂停
- 管理员手动暂停
**解决**:
1. 点击「启用」按钮
2. 如果无法启用，查看错误提示
3. 可能需要联系飞书技术支持

---

## 🚨 如果一切配置都正确

### 最后的验证步骤

#### 1. 重新启用事件订阅
即使显示「已启用」，也尝试：
1. 点击「暂停」
2. 等待10秒
3. 点击「启用」
4. 回到应用发送测试消息

#### 2. 检查应用日志
进入：运维中心 → 日志查询
- 查看是否有错误日志
- 查看是否有事件推送记录

#### 3. 创建新的测试应用
如果实在不行，创建一个全新的测试应用：
1. 创建新应用
2. 配置WebSocket事件订阅
3. 修改代码中的 App ID 和 App Secret
4. 测试是否能收到消息

---

## 📞 联系技术支持

如果以上都检查过了还是不行，需要联系飞书技术支持：

**方式1**: 开放平台右下角「在线客服」
**方式2**: 工单系统（需要企业管理员账号）

**需要提供的信息**:
- App ID: cli_a85b46e11ff6500d
- 问题描述: WebSocket连接成功但不推送事件
- 发送测试消息的时间（精确到秒）
- 测试用户的 Open ID

---

## 💡 临时解决方案：切换到HTTP模式

如果急需使用，可以临时切换到HTTP回调模式：

### 优点
- 更稳定
- 可以看到HTTP请求日志
- 易于调试

### 缺点
- 需要公网域名
- 需要配置Nginx反向代理

### 步骤
1. 准备公网域名和SSL证书
2. 在开放平台配置HTTP回调地址
3. 修改代码使用HTTP事件接收
4. 需要1-2小时开发时间

---

**下一步建议**:

1. ⭐️ **立即去开放平台检查「事件订阅」配置**（最可能的问题）
2. 确认事件订阅状态是「已启用」
3. 尝试「暂停」再「启用」
4. 如果还不行，创建新的测试应用
5. 最后才考虑联系技术支持

**检查完后告诉我结果！**
