# RCA 修复总结 - SIGINT错误与飞书连接失败

**日期**: 2025-12-13
**状态**: ✅ 已修复并验证

---

## 问题概述

**现象**: 6:54出现Claude CLI SIGINT错误，之后飞书机器人一直连接失败

**影响**: 两个飞书会话中断，用户无法继续对话

---

## 根本原因（5 Whys分析）

1. **为什么飞书失败?** → Claude进程收到SIGINT信号被终止
2. **为什么Claude收到SIGINT?** → 飞书服务优雅关闭时传递了信号
3. **为什么飞书服务关闭?** → PM2触发自动重启（22次重启记录）
4. **为什么PM2重启?** → 资源竞争（用户正在运行5457只股票的大规模数据下载任务）
5. **为什么资源竞争导致重启?** → 缺少进程隔离和资源限制配置

**可控的根本原因**:
- ❌ 服务每次重启都清空所有会话的`claude_session_id`（过于激进）
- ❌ SIGINT处理逻辑不完善（未等待Claude进程完成）
- ❌ PM2缺少资源限制配置

---

## 已实施的修复

### ✅ Fix 1: 优化会话清理策略
**问题**: 每次重启都清理24小时内的会话，导致频繁重启时上下文丢失

**修复**:
- 引入清理时间戳文件 `.feishu-last-cleanup`
- 只在24小时内未清理时才执行清理
- 防止短时间内多次重启导致的会话丢失

**文件**: `server/feishu-ws.js:110-143`

**验证**: ✅ 时间戳文件已创建（上次清理: 2025-12-13 14:39:55）

---

### ✅ Fix 2: 改进SIGINT处理
**问题**: 服务关闭时直接终止Claude子进程，导致用户看到SIGINT错误

**修复**:
1. 先停止接收新消息
2. 等待现有Claude进程完成（最多30秒）
3. 超时后使用SIGTERM（而非SIGINT）温和终止
4. 完整的日志记录

**文件**: `server/feishu-ws.js:167-239`

**预期效果**:
- 正常关闭：用户不会看到错误消息
- 超时关闭：日志清晰记录被终止的会话

---

## 验证结果

```bash
✓ Fix 1: 会话清理策略已优化
✓ Fix 2: SIGINT处理已改进
✓ 服务运行正常 (23次重启后稳定)
✓ 存在3个可恢复会话
✓ 错误日志为空
```

**运行验证脚本**:
```bash
bash /home/ccp/tests/verify-rca-fix.sh
```

---

## 后续监控指标

| 指标 | 修复前 | 预期修复后 |
|------|--------|------------|
| PM2重启频率 | 22次（短时间内） | <5次/天 |
| SIGINT错误数 | 2次（单次事件） | 0次 |
| 会话恢复成功率 | N/A | >95% |

**监控命令**:
```bash
pm2 logs feishu --lines 100          # 查看日志
pm2 monit                             # 实时监控
watch -n 5 'pm2 status | grep feishu'  # 监控状态
```

---

## 推荐的长期改进（优先级P2-P3）

1. **增加PM2资源限制** (P2)
   - 配置 `max_memory_restart: '500M'`
   - 配置 `max_restarts: 10`

2. **隔离长时间运行任务** (P2)
   - 使用任务队列（Bull/BeeQueue）
   - 独立进程运行数据下载等任务

3. **飞书API速率限制保护** (P2)
   - 使用 rate-limiter-flexible
   - 防止并发调用冲突

4. **健康监控系统** (P3)
   - 心跳检测（每30秒）
   - Claude进程超时保护（5分钟）
   - 资源使用告警

---

## 相关文档

- **详细RCA报告**: `/home/ccp/docs/RCA_SIGINT_20251213.md`
- **验证脚本**: `/home/ccp/tests/verify-rca-fix.sh`
- **修改的代码**: `server/feishu-ws.js`

---

**完成时间**: 2025-12-13 14:42
**修复人员**: Claude Code
**状态**: ✅ 已修复并上线
