# AI初老师架构说明文档

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              飞书 (Feishu) 平台                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐                                    ┌──────────────┐     │
│  │    用户      │                                    │ 小六机器人    │     │
│  │             │                                    │  (Claude)    │     │
│  └──────┬───────┘                                    └──────▲───────┘     │
│         │                                                   │             │
│         │ 1. 发送消息/@AI初老师                              │             │
│         │                                                   │ 7. 群聊响应 │
│         ▼                                                   │             │
│  ┌──────────────────────────────────────────────────────────┼──────┐     │
│  │                    飞书群聊/私聊                           │      │     │
│  └──────┬────────────────────────────────────────────────────▲──────┘     │
│         │ 2. Webhook事件                                    │             │
└─────────┼────────────────────────────────────────────────────┼─────────────┘
          │                                                   │
          ▼                                                   │ 6. 调用小六API
┌──────────────────────────────────────────────┐              │
│        AI初老师服务 (Flask)                    │              │
│           端口: 33301                         │              │
├──────────────────────────────────────────────┤              │
│                                             │              │
│  ┌────────────────────────────┐            │              │
│  │    app.py (主入口)          │            │              │
│  │  - Flask Web服务器          │            │              │
│  │  - Webhook处理器            │            │              │
│  │  - 健康检查接口             │            │              │
│  └──────────┬─────────────────┘            │              │
│             │ 3. 处理消息                   │              │
│             ▼                               │              │
│  ┌──────────────────────────────────────┐  │              │
│  │   AITeacherHandler (消息处理器)       │  │              │
│  │   - 解析用户输入                     │  │              │
│  │   - 路由到对应功能                   │  │              │
│  │   - 生成响应内容                     │  │              │
│  └─────┬────────────────────────────────┘  │              │
│        │                                   │              │
│        ├──────────────┬──────────────┬─────┼──────┬───────┼──────┐
│        ▼              ▼              ▼     ▼      ▼       ▼      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐ ┌──────────┐ ┌──────────┐
│  │ Session  │  │  Menu    │  │ Project  │ │Port     │ │Bot2Bot  │
│  │ Manager  │  │ Manager  │  │ Manager  │ │Manager  │ │Client   │
│  │          │  │          │  │          │ │         │ │         │
│  │会话管理   │  │菜单系统   │  │项目创建   │ │端口分配  │ │机器人通信│
│  └──────────┘  └──────────┘  └──────────┘ └──────────┘ └─────┬────┘
│        │              │              │                       │
│        ▼              ▼              ▼                       │
│  ┌──────────────────────────────────────────────┐           │
│  │            数据持久化层                       │           │
│  │  - sessions.json (会话状态)                  │           │
│  │  - port.csv (端口分配表)                     │           │
│  │  - prompts.json (提示词模板)                 │           │
│  └──────────────────────────────────────────────┘           │
└──────────────────────────────────────────────┐              │
                                              │              │
                                              └──────────────┘
                                                    ▼
                              ┌──────────────────────────────────────┐
                              │   小六服务 (Claude Code UI)          │
                              │        端口: 33300                  │
                              │   /api/feishu-proxy/query          │
                              └──────────────────────────────────────┘
```

## 通俗易懂的架构解释

### 什么是AI初老师？

AI初老师是一个飞书机器人，就像一个智能助教，专门帮助用户快速创建各种小应用和游戏。你可以把它想象成一个"代码生成魔法师"。

### 工作流程（用生活化的比喻）

想象你去餐厅点餐：

1. **点餐阶段**：你（用户）在飞书群里@AI初老师，就像在餐厅呼叫服务员
2. **看菜单**：AI初老师会给你展示一个菜单，包含9个选项（扫雷、贪吃蛇、计算器等）
3. **下单**：你输入数字（比如11代表扫雷），就像告诉服务员你要什么菜
4. **传递订单**：AI初老师记下你的选择，然后把具体的制作要求传给厨师（小六机器人）
5. **制作过程**：小六机器人（Claude）开始编写代码，就像厨师在厨房做菜
6. **上菜**：做好的应用会自动发布到网上，你会收到访问链接

### 核心模块详解

#### 1. Flask Web服务器（app.py）
- **作用**：像餐厅的大门和前台
- **功能**：接收飞书发来的消息，分发给相应的处理器

#### 2. AITeacherHandler（消息处理器）
- **作用**：像餐厅的大堂经理
- **功能**：
  - 理解用户想要什么（解析输入）
  - 决定该做什么（路由选择）
  - 协调各个部门工作

#### 3. SessionManager（会话管理器）
- **作用**：像服务员的记事本
- **功能**：
  - 记住每个用户的状态（是否看过菜单、选了什么）
  - 保存聊天历史
  - 即使服务重启也能记住之前的对话

#### 4. MenuManager（菜单管理器）
- **作用**：像餐厅的菜单系统
- **功能**：
  - 展示9个可选应用
  - 理解用户的选择（支持各种输入格式）
  - 提供应用详细信息

#### 5. ProjectManager（项目管理器）
- **作用**：像厨房的配方管理系统
- **功能**：
  - 为每个用户创建独立的项目文件夹
  - 生成详细的开发指令（prompt）
  - 管理项目模板

#### 6. PortManager（端口管理器）
- **作用**：像停车场的车位分配系统
- **功能**：
  - 为全栈应用分配独立的服务端口（57001起）
  - 确保端口不冲突
  - 记录端口使用情况

#### 7. Bot2BotClient（机器人通信客户端）
- **作用**：像餐厅与厨房之间的对讲机
- **功能**：
  - 把任务发送给小六机器人
  - 传递必要的上下文信息
  - 处理通信错误

### 数据存储

系统使用三个主要的数据文件：

1. **sessions.json**：保存用户的会话状态，就像服务员的订单本
2. **port.csv**：记录端口分配，就像停车场的车位登记表
3. **prompts.json**：存储开发模板，就像厨房的标准菜谱

### 特色功能

#### 1. 智能菜单解析
系统能理解各种输入方式：
- 纯数字："11"
- 带描述："11-扫雷"
- 口语化："我要选11"
- 甚至带@符号："11@AI初老师"

#### 2. 会话持久化
即使服务重启，也能记住用户之前的选择和状态，提供连续的体验。

#### 3. 自动化部署
生成的应用会自动发布到 `https://s.linapp.fun/用户拼音_应用拼音.html`，用户可以立即访问。

#### 4. Bot-to-Bot协作
AI初老师负责理解需求和生成任务，小六机器人负责具体编码实现，两个机器人协同工作。

### 技术栈

- **后端语言**：Python 3 + Flask
- **通信协议**：HTTP Webhook
- **数据存储**：JSON文件
- **部署方式**：PM2进程管理
- **服务端口**：33301（AI初老师）、33300（小六服务）

### 部署和运维

#### 启动服务
```bash
cd teacher
python app.py  # 开发模式
# 或
pm2 start ecosystem.config.cjs  # 生产模式
```

#### 查看日志
```bash
tail -f teacher.log  # 查看运行日志
pm2 logs AI-Teacher  # 查看PM2日志
```

#### 健康检查
访问 `http://localhost:33301/health` 可以检查服务状态

### 小贴士

1. **群聊使用**：在群里必须@AI初老师才会响应
2. **私聊使用**：私聊会自动响应所有消息
3. **重置会话**：开发模式下可以通过API重置用户会话
4. **端口管理**：全栈应用从57001开始自动分配端口

## 总结

AI初老师就像一个贴心的编程助教，通过简单的数字选择，就能帮你生成完整的应用。它与小六机器人配合，一个负责理解需求，一个负责编写代码，共同为用户提供"一键生成云上应用"的神奇体验。