# é£ä¹¦é›†æˆè‡ªåŠ¨åŒ–å¼€å‘ç³»ç»Ÿ

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œå…¨è‡ªåŠ¨åŒ–çš„å¼€å‘ç³»ç»Ÿï¼Œèƒ½å¤Ÿè‡ªä¸»æ‰§è¡Œ `task.md` ä¸­å®šä¹‰çš„æ‰€æœ‰å¼€å‘ä»»åŠ¡ï¼ŒåŒ…æ‹¬ï¼š
- è‡ªåŠ¨è¯»å–éœ€æ±‚å’Œè®¾è®¡æ–‡æ¡£
- æ™ºèƒ½ä¾èµ–ç®¡ç†
- å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆæç¤ºè¯è¿­ä»£å‡çº§ï¼‰
- é£ä¹¦å®æ—¶é€šçŸ¥
- å®Œæ•´çš„çŠ¶æ€è·Ÿè¸ªå’Œæ—¥å¿—è®°å½•

## ğŸ“ æ–‡ä»¶ç»“æ„

```
feishu/
â”œâ”€â”€ need.md                    # éœ€æ±‚æ–‡æ¡£
â”œâ”€â”€ design.md                  # æ¶æ„è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ task.md                    # ä»»åŠ¡æ¸…å•ï¼ˆ41ä¸ªä»»åŠ¡ï¼‰
â”œâ”€â”€ task-state.json            # ä»»åŠ¡çŠ¶æ€è·Ÿè¸ªï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ task-state.schema.json     # çŠ¶æ€æ–‡ä»¶JSON Schema
â”œâ”€â”€ task-parser.cjs            # ä»»åŠ¡è§£æå™¨
â”œâ”€â”€ auto-dev-runner.cjs        # æ ¸å¿ƒè°ƒåº¦å™¨ â­
â”œâ”€â”€ auto-dev.sh                # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ setup-cron.sh              # Croné…ç½®å·¥å…·
â”œâ”€â”€ feishu-notifier.cjs        # é£ä¹¦é€šçŸ¥æ¨¡å—
â”œâ”€â”€ prompts/                   # æç¤ºè¯æ¨¡æ¿ï¼ˆ4çº§ï¼‰
â”‚   â”œâ”€â”€ level-0-friendly.txt   # Level 0: å‹å¥½æ¨¡å¼
â”‚   â”œâ”€â”€ level-1-retry.txt      # Level 1: é‡è¯•æ¨¡å¼
â”‚   â”œâ”€â”€ level-2-strict.txt     # Level 2: ä¸¥æ ¼æ¨¡å¼
â”‚   â””â”€â”€ level-3-pua.txt        # Level 3: PUAæ¨¡å¼ï¼ˆæœ€åé€šç‰’ï¼‰
â””â”€â”€ logs/                      # æ‰§è¡Œæ—¥å¿—
    â”œâ”€â”€ cron.log               # Cronæ‰§è¡Œæ—¥å¿—
    â””â”€â”€ YYYY-MM-DD....log      # Claudeæ‰§è¡Œæ—¥å¿—
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€

```bash
cd /home/ccp/feishu
node task-parser.cjs
```

è¿™å°†è§£æ `task.md` å¹¶ç”Ÿæˆ `task-state.json`ï¼ˆ41ä¸ªä»»åŠ¡ï¼‰ã€‚

### 2. é…ç½®é£ä¹¦é€šçŸ¥ï¼ˆå¯é€‰ï¼‰

**ç¯å¢ƒå˜é‡è¯´æ˜**ï¼š

ç³»ç»Ÿä½¿ç”¨ä»¥ä¸‹ç¯å¢ƒå˜é‡é…ç½®é£ä¹¦é€šçŸ¥ï¼š

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | çŠ¶æ€ | å¿…éœ€ |
|---------|------|------|------|
| `FeishuCC_App_ID` | é£ä¹¦åº”ç”¨ID | âœ… å·²è®¾ç½® | æ˜¯ |
| `FeishuCC_App_Secret` | é£ä¹¦åº”ç”¨å¯†é’¥ | âœ… å·²è®¾ç½® | æ˜¯ |
| `FEISHU_NOTIFY_RECEIVE_ID` | é€šçŸ¥æ¥æ”¶è€…ID | âš ï¸ æœªè®¾ç½® | å¦ï¼ˆä½†å¼ºçƒˆå»ºè®®ï¼‰ |

**é…ç½®é€šçŸ¥æ¥æ”¶è€…**ï¼š

```bash
# 1. è·å–ä½ çš„ open_id
node test-feishu-ws.js
# é£ä¹¦ä¸­ç»™æœºå™¨äººå‘æ¶ˆæ¯ï¼Œæ§åˆ¶å°ä¼šæ˜¾ç¤ºä½ çš„ open_id

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
export FEISHU_NOTIFY_RECEIVE_ID=ou_xxxxx  # æ›¿æ¢ä¸ºä½ çš„ open_id

# 3. æ°¸ä¹…ä¿å­˜ï¼ˆæ¨èï¼‰
echo 'export FEISHU_NOTIFY_RECEIVE_ID=ou_xxxxx' >> ~/.bashrc
source ~/.bashrc
```

å¦‚æœä¸é…ç½®æ¥æ”¶è€…IDï¼Œç³»ç»Ÿå°†ç¦ç”¨é£ä¹¦é€šçŸ¥åŠŸèƒ½ï¼Œä½†ä¸å½±å“è‡ªåŠ¨åŒ–ä»»åŠ¡æ‰§è¡Œã€‚

### 3. æµ‹è¯•å•æ¬¡æ‰§è¡Œ

```bash
./auto-dev.sh
```

è¿™å°†æ‰§è¡Œä¸€æ¬¡è‡ªåŠ¨åŒ–å¼€å‘ä»»åŠ¡ã€‚è§‚å¯Ÿè¾“å‡ºï¼Œç¡®ä¿æµç¨‹æ­£å¸¸ã€‚

### 4. é…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯10åˆ†é’Ÿï¼‰

```bash
./setup-cron.sh
```

é€‰æ‹© `1` æ·»åŠ  cron ä»»åŠ¡ã€‚ä¹‹åç³»ç»Ÿä¼šæ¯10åˆ†é’Ÿè‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ã€‚

## ğŸ›ï¸ æ§åˆ¶å‘½ä»¤

### æš‚åœè‡ªåŠ¨åŒ–

```bash
touch .auto-dev-pause
```

Cron ä¼šæ£€æµ‹åˆ°æ­¤æ–‡ä»¶å¹¶è·³è¿‡æ‰§è¡Œã€‚ä»»åŠ¡çŠ¶æ€è¢«ä¿ç•™ã€‚

### æ¢å¤è‡ªåŠ¨åŒ–

```bash
rm .auto-dev-pause
```

### æ‰‹åŠ¨ä¿®å¤åæ¢å¤

å¦‚æœä»»åŠ¡å¤±è´¥3æ¬¡åç³»ç»Ÿæš‚åœï¼Œä¿®å¤é—®é¢˜åï¼š

```bash
# ç¼–è¾‘ task-state.json
vi task-state.json

# ä¿®æ”¹:
# "globalStatus": "paused" â†’ "running"
# "retryCount": 3 â†’ 0  ï¼ˆé‡ç½®å¤±è´¥ä»»åŠ¡çš„é‡è¯•è®¡æ•°ï¼‰

# åˆ é™¤æš‚åœæ ‡è®°
rm .auto-dev-pause
```

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
# Cron æ—¥å¿—
tail -f logs/cron.log

# æœ€æ–°çš„ Claude æ‰§è¡Œæ—¥å¿—
tail -f logs/$(ls -t logs/*.log | head -1)
```

### æŸ¥çœ‹å½“å‰çŠ¶æ€

```bash
node -e "const s=require('./task-state.json'); console.log('çŠ¶æ€:', s.globalStatus); console.log('è¿›åº¦:', s.currentTaskIndex+1, '/', s.tasks.length)"
```

## ğŸ“Š å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cron æ¯10åˆ†é’Ÿè§¦å‘                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auto-dev.sh                             â”‚
â”‚  - æ£€æŸ¥æš‚åœæ ‡è®°                          â”‚
â”‚  - æ£€æŸ¥å…¨å±€çŠ¶æ€                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auto-dev-runner.cjs                     â”‚
â”‚  1. åŠ è½½ task-state.json                 â”‚
â”‚  2. æ‰¾åˆ°å½“å‰æœªå®Œæˆä»»åŠ¡                   â”‚
â”‚  3. æ£€æŸ¥ä¾èµ–å…³ç³»                         â”‚
â”‚  4. ç”Ÿæˆæç¤ºè¯ï¼ˆLevel 0-3ï¼‰              â”‚
â”‚  5. è°ƒç”¨ claude CLI                      â”‚
â”‚  6. è§£æè¾“å‡ºï¼ˆâœ…/âŒï¼‰                     â”‚
â”‚  7. æ›´æ–°çŠ¶æ€ã€è®°å½•æ—¥å¿—                   â”‚
â”‚  8. å‘é€é£ä¹¦é€šçŸ¥                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                â”‚
           â–¼                â–¼
      æˆåŠŸï¼šæ¨è¿›         å¤±è´¥ï¼šé‡è¯•
      åˆ°ä¸‹ä¸€ä»»åŠ¡         (max 3æ¬¡)
```

## ğŸ”„ é‡è¯•ç­–ç•¥

ä»»åŠ¡å¤±è´¥æ—¶ä¼šè‡ªåŠ¨é‡è¯•ï¼Œæç¤ºè¯é€çº§å‡çº§ï¼š

| é‡è¯•æ¬¡æ•° | æç¤ºè¯çº§åˆ« | æè¿° |
|---------|-----------|------|
| 0ï¼ˆé¦–æ¬¡ï¼‰ | Level 0 | å‹å¥½ã€è¯¦ç»†æŒ‡å¯¼ |
| 1 | Level 1 | å¼ºè°ƒå¤±è´¥åŸå› ï¼Œå»ºè®®æ›¿ä»£æ–¹æ¡ˆ |
| 2 | Level 2 | ä¸¥æ ¼è¦æ±‚ï¼Œå¼ºåˆ¶æ­¥éª¤ |
| 3 | Level 3 | PUAæ¨¡å¼ï¼ˆæœ€åé€šç‰’ï¼‰ |
| >3 | - | æš‚åœï¼Œç­‰å¾…äººå·¥ä»‹å…¥ |

## ğŸ“± é£ä¹¦é€šçŸ¥äº‹ä»¶

ç³»ç»Ÿä¼šåœ¨ä»¥ä¸‹æ—¶æœºå‘é€é£ä¹¦é€šçŸ¥ï¼š

1. **ä»»åŠ¡å¼€å§‹** - æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯ã€è¿›åº¦ã€é‡è¯•æ¬¡æ•°
2. **ä»»åŠ¡å®Œæˆ** - æ˜¾ç¤ºè€—æ—¶ã€æ€»è¿›åº¦ç™¾åˆ†æ¯”
3. **ä»»åŠ¡å¤±è´¥** - æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€Claudeè¾“å‡ºæ‘˜è¦
4. **ç³»ç»Ÿæš‚åœ** - æ˜¾ç¤ºå¤±è´¥å†å²ã€äººå·¥ä»‹å…¥æç¤º
5. **å…¨éƒ¨å®Œæˆ** - æ˜¾ç¤ºç»Ÿè®¡æ•°æ®ã€åç»­æ­¥éª¤

é€šçŸ¥æ ¼å¼ä¸ºé£ä¹¦å¯Œæ–‡æœ¬å¡ç‰‡ï¼ŒåŒ…å«è¯¦ç»†ä¿¡æ¯ã€‚

## ğŸ› ï¸ é«˜çº§ç”¨æ³•

### è·³è¿‡æŸä¸ªä»»åŠ¡

ç¼–è¾‘ `task-state.json`ï¼š

```json
{
  "id": "stage1-task0",
  "status": "completed",  // æ”¹ä¸º completed
  "completedAt": "2024-11-24T12:00:00Z"
}
```

### æ‰‹åŠ¨æ¨è¿›åˆ°ç‰¹å®šä»»åŠ¡

ç¼–è¾‘ `task-state.json`ï¼š

```json
{
  "currentTaskIndex": 10,  // è®¾ç½®ä¸ºç›®æ ‡ä»»åŠ¡ç´¢å¼•
  "globalStatus": "running"
}
```

### æ·»åŠ è‡ªå®šä¹‰éªŒè¯è„šæœ¬

ç¼–è¾‘ `task-state.json`ï¼Œä¸ºç‰¹å®šä»»åŠ¡æ·»åŠ ï¼š

```json
{
  "id": "stage5-task3",
  "verificationScript": "npm test"  // è‡ªåŠ¨è¿è¡Œæµ‹è¯•éªŒè¯
}
```

### è°ƒæ•´è¶…æ—¶æ—¶é—´

ç¼–è¾‘ `auto-dev.sh`ï¼š

```bash
TIMEOUT=1200  # æ”¹ä¸º20åˆ†é’Ÿ
```

## ğŸ“ˆ ç›‘æ§ä¸è°ƒè¯•

### æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡

```bash
node -e "
const s = require('./task-state.json');
const stages = {};
s.tasks.forEach(t => {
  if (!stages[t.stage]) stages[t.stage] = {total:0, done:0};
  stages[t.stage].total++;
  if (t.status === 'completed') stages[t.stage].done++;
});
Object.keys(stages).sort().forEach(st => {
  const {total, done} = stages[st];
  console.log(\`é˜¶æ®µ \${st}: \${done}/\${total}\`);
});
"
```

### æŸ¥çœ‹å¤±è´¥ä»»åŠ¡

```bash
node -e "
const s = require('./task-state.json');
s.tasks
  .filter(t => t.status === 'blocked' || t.retryCount > 0)
  .forEach(t => console.log(\`\${t.id}: \${t.title} (é‡è¯•:\${t.retryCount})\`));
"
```

### å¯¼å‡ºæ‰§è¡ŒæŠ¥å‘Š

```bash
node -e "
const s = require('./task-state.json');
console.log('æ€»ä»»åŠ¡:', s.tasks.length);
console.log('å·²å®Œæˆ:', s.tasks.filter(t=>t.status==='completed').length);
console.log('è¿›è¡Œä¸­:', s.tasks.filter(t=>t.status==='in_progress').length);
console.log('é˜»å¡:', s.tasks.filter(t=>t.status==='blocked').length);
console.log('æ€»å°è¯•:', s.totalAttempts);
console.log('å¹³å‡é‡è¯•:', (s.totalAttempts/s.tasks.length).toFixed(2));
" > report.txt
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šCron ä»»åŠ¡ä¸æ‰§è¡Œ

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ cron æ˜¯å¦è¿è¡Œ
systemctl status cron

# æ£€æŸ¥ crontab é…ç½®
crontab -l | grep auto-dev

# æ£€æŸ¥æ—¥å¿—
tail -f logs/cron.log
```

### é—®é¢˜ï¼šClaude CLI æ‰¾ä¸åˆ°

**è§£å†³æ–¹æ³•**ï¼š
```bash
# ç¡®è®¤ claude åœ¨ PATH ä¸­
which claude

# å¦‚æœä¸åœ¨ï¼Œæ·»åŠ åˆ° crontab
# ç¼–è¾‘ crontab: crontab -e
# åœ¨é¡¶éƒ¨æ·»åŠ : PATH=/usr/local/bin:/usr/bin:/bin:$PATH
```

### é—®é¢˜ï¼šä»»åŠ¡ä¸€ç›´å¤±è´¥

**è§£å†³æ–¹æ³•**ï¼š
1. æŸ¥çœ‹æœ€æ–°æ—¥å¿—ï¼š`ls -lt logs/*.log | head -1`
2. åˆ†æ Claude è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯
3. æ‰‹åŠ¨æ‰§è¡Œ Claude å‘½ä»¤æµ‹è¯•ï¼š
   ```bash
   claude --dangerously-skip-permissions -p "$(cat prompts/level-0-friendly.txt | sed 's/{{TASK_TITLE}}/æµ‹è¯•ä»»åŠ¡/g')"
   ```
4. å¦‚æœæ˜¯ä»»åŠ¡æœ¬èº«æœ‰é—®é¢˜ï¼Œä¿®æ”¹ `task.md` å¹¶é‡æ–°ç”ŸæˆçŠ¶æ€ï¼š
   ```bash
   node task-parser.cjs
   ```

### é—®é¢˜ï¼šé£ä¹¦é€šçŸ¥ä¸å‘é€

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $FEISHU_NOTIFY_RECEIVE_ID

# æµ‹è¯•é£ä¹¦é€šçŸ¥
node feishu-notifier.cjs

# æ£€æŸ¥å‡­è¯
node test-send-message.js
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `need.md` - é£ä¹¦é›†æˆéœ€æ±‚æ–‡æ¡£
- `design.md` - æ¶æ„è®¾è®¡æ–‡æ¡£
- `task.md` - å®Œæ•´ä»»åŠ¡æ¸…å•ï¼ˆ41ä¸ªä»»åŠ¡ï¼Œ8ä¸ªé˜¶æ®µï¼‰
- `task-state.schema.json` - çŠ¶æ€æ–‡ä»¶JSON Schema

## ğŸ‰ é¢„æœŸç»“æœ

ç³»ç»Ÿè¿è¡Œå®Œæˆåï¼ˆé¢„è®¡6å°æ—¶ï¼Œ41ä¸ªä»»åŠ¡ï¼‰ï¼Œå°†è‡ªåŠ¨å®Œæˆï¼š

1. âœ… æ•°æ®åº“æ‰©å±•ï¼ˆ`server/database/db.js`ï¼‰
2. âœ… é£ä¹¦å®¢æˆ·ç«¯ï¼ˆ`server/lib/feishu-client.js`ï¼‰
3. âœ… æ¶ˆæ¯å†™å…¥å™¨ï¼ˆ`server/lib/feishu-message-writer.js`ï¼‰
4. âœ… ä¼šè¯ç®¡ç†å™¨ï¼ˆ`server/lib/feishu-session.js`ï¼‰
5. âœ… ä¸»æœåŠ¡ï¼ˆ`server/feishu-ws.js`ï¼‰
6. âœ… REST APIï¼ˆ`server/routes/feishu.js`ï¼‰
7. âœ… é›†æˆåˆ°ä¸»æœåŠ¡
8. âœ… å®Œæ•´æµ‹è¯•

æœ€ç»ˆå¯ä»¥è¿è¡Œï¼š
```bash
npm run feishu  # å¯åŠ¨é£ä¹¦æœºå™¨äººæœåŠ¡
```

## ğŸ’¡ æç¤º

- **ç¬¬ä¸€æ¬¡è¿è¡Œå»ºè®®æ‰‹åŠ¨æ‰§è¡Œ**ï¼Œè§‚å¯Ÿæµç¨‹ï¼š`./auto-dev.sh`
- **å¯ç”¨ cron å‰å»ºè®®å…ˆæµ‹è¯•2-3ä¸ªä»»åŠ¡**ï¼Œç¡®ä¿æµç¨‹æ­£å¸¸
- **å®šæœŸæ£€æŸ¥æ—¥å¿—**ï¼Œäº†è§£ä»»åŠ¡è¿›å±•
- **é‡åˆ°æš‚åœåŠæ—¶å¤„ç†**ï¼Œé¿å…é•¿æ—¶é—´ä¸­æ–­
- **ä¿ç•™ task-state.json å¤‡ä»½**ï¼Œæ–¹ä¾¿å›æ»š

---

**åˆ›å»ºæ—¶é—´**: 2024-11-24
**ç‰ˆæœ¬**: 1.0.0
**ä½œè€…**: Claude Code è‡ªåŠ¨åŒ–å¼€å‘ç³»ç»Ÿ
