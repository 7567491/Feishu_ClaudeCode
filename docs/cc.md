# Claude Code UI 主服务架构

## 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        用户/客户端层                                  │
├─────────────────────────────────────────────────────────────────────┤
│  浏览器前端          飞书客户端         AI初老师机器人     外部系统   │
│  (React UI)         (群聊/私聊)        (Python Flask)    (API调用)  │
└──────┬──────────────────┬──────────────────┬─────────────────┬──────┘
       │                  │                  │                 │
       │WebSocket         │Webhook          │Bot-to-Bot      │REST API
       │                  │                  │HTTP            │
       ▼                  ▼                  ▼                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    主 API 服务 (Express.js)                         │
│                        端口: 33300                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────┐  ┌─────────────────┐  ┌──────────────────┐   │
│  │   WebSocket    │  │    路由系统      │  │   中间件系统      │   │
│  │   服务器       │  │                  │  │                   │   │
│  ├────────────────┤  ├─────────────────┤  ├──────────────────┤   │
│  │ • /ws 聊天     │  │ • /api/auth     │  │ • 身份验证        │   │
│  │ • /shell 终端  │  │ • /api/projects │  │ • API Key验证     │   │
│  │ • 实时消息     │  │ • /api/feishu   │  │ • Token验证       │   │
│  │ • 会话管理     │  │ • /api/git      │  │ • CORS处理        │   │
│  └────────────────┘  │ • /api/cursor   │  │ • 请求日志        │   │
│                      │ • /api/mcp      │  └──────────────────┘   │
│                      │ • /api/settings │                          │
│                      │ • /api/user     │                          │
│                      │ • /webhook      │                          │
│                      │ • /api/feishu-  │                          │
│                      │   proxy         │                          │
│                      └─────────────────┘                          │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │                    业务逻辑层                                │   │
│  ├────────────────────────────────────────────────────────────┤   │
│  │                                                              │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │   │
│  │  │ Claude CLI   │  │ 飞书集成      │  │ 项目管理      │     │   │
│  │  │ 控制器       │  │               │  │               │     │   │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤     │   │
│  │  │ • 会话管理   │  │ • 消息处理    │  │ • 项目列表    │     │   │
│  │  │ • 命令执行   │  │ • 文件转换    │  │ • 会话历史    │     │   │
│  │  │ • 流式输出   │  │ • 群组管理    │  │ • 文件操作    │     │   │
│  │  │ • 会话恢复   │  │ • Bot通信     │  │ • Git操作     │     │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘     │   │
│  │                                                              │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │   │
│  │  │ Cursor CLI   │  │ MCP服务      │  │ 文件服务      │     │   │
│  │  │ 控制器       │  │               │  │               │     │   │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤     │   │
│  │  │ • AI编辑器   │  │ • 工具集成    │  │ • 文件读写    │     │   │
│  │  │ • 代码生成   │  │ • 插件管理    │  │ • 目录浏览    │     │   │
│  │  │ • 模型切换   │  │ • 命令执行    │  │ • 文件监控    │     │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘     │   │
│  │                                                              │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         数据持久层                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │
│  │  SQLite数据库   │  │   文件系统        │  │  外部服务         │   │
│  ├────────────────┤  ├──────────────────┤  ├──────────────────┤   │
│  │ • users        │  │ • /home/ccp/     │  │ • Claude CLI     │   │
│  │ • feishu_      │  │   feicc/         │  │ • Cursor编辑器   │   │
│  │   sessions     │  │ • .claude/       │  │ • 飞书API        │   │
│  │ • feishu_      │  │   projects/      │  │ • GitHub API     │   │
│  │   message_log  │  │ • /mnt/www/      │  │ • DeepSeek API   │   │
│  │ • feishu_      │  │   静态文件        │  │                  │   │
│  │   credentials  │  └──────────────────┘  └──────────────────┘   │
│  │ • feishu_      │                                                 │
│  │   group_members│                                                 │
│  └────────────────┘                                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## 通俗易懂的架构解释

### 整体概述

Claude Code UI 的主服务就像一个"智能助手中心"，它连接了多个不同的客户端和服务，让用户可以通过网页、飞书群聊等多种方式来使用 Claude AI 进行编程和对话。

### 核心组件说明

#### 1. 用户接入层（最顶层）
这一层是用户直接接触的部分：

- **浏览器前端**：一个 React 编写的网页界面，用户可以在浏览器中直接和 Claude 对话
- **飞书客户端**：用户可以在飞书群聊或私聊中@机器人来使用服务
- **AI初老师机器人**：一个特殊的 Python 服务，提供菜单式的引导服务
- **外部系统**：其他系统可以通过 API 调用服务

#### 2. 主 API 服务（中间核心层）
这是整个系统的"大脑"，运行在 33300 端口上，使用 Express.js 框架：

**WebSocket 服务器**
- 提供实时双向通信能力
- `/ws` 端点：处理聊天消息，实现流式输出
- `/shell` 端点：提供终端功能

**路由系统**
负责处理各种 HTTP 请求，每个路由对应不同的功能：
- `/api/auth`：用户登录认证
- `/api/projects`：管理 Claude 项目
- `/api/feishu`：飞书相关功能
- `/api/feishu-proxy`：专门为 AI初老师提供的接口
- `/webhook`：接收飞书发来的消息

**中间件系统**
像"安保人员"一样，检查每个请求：
- 验证用户身份
- 检查 API Key
- 处理跨域请求

#### 3. 业务逻辑层
这层包含了实际的业务处理逻辑：

**Claude CLI 控制器**
- 管理与 Claude AI 的对话会话
- 执行用户的命令
- 处理流式输出（像打字机一样一个字一个字地显示）
- 支持会话恢复（断线重连后可以继续之前的对话）

**飞书集成**
- 处理飞书消息
- 将 Markdown 文件转换成飞书文档
- 管理群组成员信息
- 实现机器人之间的通信

**项目管理**
- 管理用户的编程项目
- 保存对话历史
- 处理文件的读写操作
- 集成 Git 版本控制

#### 4. 数据持久层（底层）
负责保存所有数据：

**SQLite 数据库**
像一个"记事本"，保存：
- 用户信息
- 飞书会话记录
- 消息历史
- API 密钥

**文件系统**
- `/home/ccp/feicc/`：为每个飞书会话创建独立的工作目录
- `.claude/projects/`：存储 Claude 项目文件
- `/mnt/www/`：存放 AI初老师生成的网页应用

**外部服务**
- Claude CLI：实际的 AI 大脑
- 飞书 API：与飞书平台通信
- GitHub API：代码版本管理
- DeepSeek API：用于生成对话摘要

### 工作流程示例

#### 场景1：用户在网页上发送消息
1. 用户在浏览器中输入消息
2. 通过 WebSocket 发送到主服务
3. 主服务调用 Claude CLI
4. Claude 返回回答（流式输出）
5. 通过 WebSocket 实时推送给浏览器
6. 用户看到 AI 逐字打出回答

#### 场景2：飞书群聊中使用
1. 用户在飞书群里 @机器人 提问
2. 飞书通过 Webhook 发送消息到主服务
3. 主服务识别是群聊消息
4. 创建或恢复该群的会话
5. 调用 Claude 获取回答
6. 通过飞书 API 发送回复到群里
7. 如果有生成文件，自动转换成飞书文档

#### 场景3：AI初老师引导模式
1. 用户选择 AI初老师的菜单选项
2. AI初老师通过 Bot-to-Bot API 调用主服务
3. 主服务处理请求，调用 Claude
4. 返回结果给 AI初老师
5. AI初老师将结果发送给用户

### 特色功能

1. **会话持久化**：即使服务重启，也能继续之前的对话
2. **多租户隔离**：每个用户/群组的文件相互隔离
3. **流式输出**：像人打字一样逐字显示，提升体验
4. **文件自动转换**：生成的 Markdown 自动变成飞书文档
5. **智能路由**：根据不同的请求类型自动选择处理方式

### 安全设计

1. **身份验证**：所有 API 都需要验证身份
2. **路径隔离**：用户只能访问自己的文件
3. **会话管理**：24小时不活跃自动清理
4. **API Key保护**：敏感信息加密存储

### 性能优化

1. **并发处理**：支持多用户同时使用
2. **缓存机制**：减少重复查询
3. **流式传输**：大文件分块传输
4. **连接复用**：WebSocket 长连接减少开销

## 总结

主服务就像一个智能的"调度中心"，它：
- 接收来自不同渠道的请求（网页、飞书、API）
- 调用合适的服务处理（Claude、文件系统、数据库）
- 将结果以合适的方式返回给用户

整个架构设计简洁高效，易于扩展，能够同时服务多个用户，提供流畅的 AI 编程体验。