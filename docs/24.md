# 24x7 持续驱动方案（AI 初老师 → 小六）

目标：让 AI 初老师在无人干预的情况下，24 小时循环驱动小六持续完善现有项目、生成新项目，并保持可观测、可暂停、可恢复。

## 架构概览
- 调度层：定时或队列触发器（Cron/PM2/队列）定期拉取任务 → 调用初老师 → 转发给小六。
- 任务池：持久化的待办队列，含状态（pending/doing/done/failed）、重试次数、所属项目/会话、绑定 chat_id。
- 执行链：初老师根据模板构造 Prompt（复用 `teacher/prompts.json` 或新增模板），通过 `/api/feishu-proxy/query` 发送给小六。
- 健康与安全：心跳探测、失败熔断、资源清理、敏感信息扫描，报警到飞书/日志。

## 调度层（24h 循环）
- 触发方式：Cron/PM2 定时任务或 Bull 队列；周期拉取任务池。如果空闲则生成“维护任务”。
- 并发控制：同一项目串行；跨项目可并行，设置并发上限防止 Claude 会话/端口争用。
- 熔断策略：连续失败/健康检查异常时暂停派发并报警。

## 任务来源
- 现有项目维护：扫描 `feicc/` 或仓库，收集未完成计划项、未发送的 md、lint/test 报错 → 入池。
- 新项目生成：从模板池或预置 prompt 列表生成需求（随机/轮询）；可选接 GitHub issue 列表。
- 任务池存储：JSON/DB 记录任务、chat_id、状态与重试次数，支持重试/回滚/人工介入。

## 执行编排（初老师 → 小六）
- Prompt 构造：按 1/2（前端单页）与 3（全栈）模板生成，需包含项目路径、域名、端口等上下文。可在 `teacher/prompts.json` 增加“维护/新项目”模板。
- 会话绑定：确保任务绑定真实 `oc_/ou_/ocb_/oci_` chat_id，避免占位 ID 400；任务池内保存。
- 派发调用：调用 `POST /api/feishu-proxy/query`，fromBot=AI初老师，携带 prompt 与 chat_id。
- 重试策略：HTTP/业务失败时指数退避+上限；失败记录留池或标记人工处理。

## 健康与安全
- 心跳/报警：探测 feishu-proxy、Claude CLI、端口占用；连续失败报警飞书。
- 资源守护：定期清理 `feicc/`、端口表、临时文件；监控磁盘/端口耗尽。
- 内容防泄漏：发送前扫描 md/日志敏感信息（token/密钥）；命中则阻断或提醒。

## 实施路径（基于现有代码）
- 新增调度脚本：在 `teacher/` 下增加 scheduler（Python APScheduler 或 Node/Bull），PM2 托管。
- 扩展模板：在 `teacher/prompts.json` 增加“维护/新项目” prompt，调度循环调用。
- 校验 chat_id：在调度器/任务池入队时验证前缀，避免测试/占位 ID。
- 观测与报警：复用/扩展 `server/lib/monitor.js` 或新脚本，记录任务状态与失败；输出飞书通知。
- 手动开关：提供“暂停派发/恢复派发”指令或环境变量，便于紧急停机。
